<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ›ï¸ è–ç‘ªæ™ºæ…§æ’åºŠç³»çµ± v2.0 - æ™ºæ…§å„ªå…ˆæ¬Šæ¼”ç®—æ³•</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .header { text-align: center; color: white; margin-bottom: 30px; }
    .logo { font-size: 2.5em; margin-bottom: 10px; }
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    .card { border-radius: 16px; padding: 24px; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
    .urgency-high { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; }
    .urgency-med { background: linear-gradient(45deg, #ffd43b, #ffe66d); color: #856404; }
    .available { background: linear-gradient(45deg, #51cf66, #74c69d); color: white; }
    .assigned { background: linear-gradient(45deg, #007bff, #339af0); color: white; }
    button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s; }
    .assign-btn { background: #28a745; color: white; }
    .assign-btn:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40,167,69,0.4); }
    .assign-btn:disabled { background: #6c757d; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    .priority-score { font-size: 24px; font-weight: bold; color: #007bff; }
    .progress-bar { width: 100%; height: 28px; background: #eee; border-radius: 14px; overflow: hidden; margin: 16px 0; }
    .progress-fill { height: 100%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
    .score-breakdown { font-size: 12px; color: #666; margin-top: 6px; background: #f8f9fa; padding: 8px; border-radius: 6px; }
    .fhir-status { position: fixed; top: 20px; right: 20px; padding: 12px; background: #28a745; color: white; border-radius: 8px; font-weight: bold; }
    .controls { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    select, input { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">ğŸ¥ è–ç‘ªæ™ºæ…§æ’åºŠç³»çµ±</div>
    <h2>æ™ºæ…§å„ªå…ˆæ¬Šæ¼”ç®—æ³• v2.0 | THAS FHIR ç›¸å®¹</h2>
    <div id="fhirStatus" class="fhir-status" style="display: none;">âœ… FHIRé€£ç·šæˆåŠŸ</div>
  </div>

  <div class="controls">
    <select id="departmentFilter">
      <option value="">å…¨é™¢</option>
      <option value="å…§ç§‘">å…§ç§‘</option>
      <option value="å¤–ç§‘">å¤–ç§‘</option>
      <option value="åŠ è­·">åŠ è­·ç—…æˆ¿</option>
      <option value="å¿ƒè‡Ÿå…§ç§‘">å¿ƒè‡Ÿå…§ç§‘</option>
    </select>
    <button class="assign-btn" onclick="autoAssignAll()" style="font-size: 16px;">
      ğŸš€ å…¨éƒ¨æ™ºæ…§è‡ªå‹•é…åºŠ
    </button>
    <button class="assign-btn" onclick="addDemoPatient()" style="background: #17a2b8;">
      â• æ–°å¢æ¸¬è©¦ç—…æ‚£
    </button>
    <div style="margin-left: auto; font-weight: bold; color: white;">
      æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdate">å³æ™‚</span>
    </div>
  </div>

  <div class="dashboard">
    <div class="card">
      <h3>ğŸš¨ å€™åºŠç—…æ‚£ (æ™ºæ…§å„ªå…ˆæ’åº)</h3>
      <div id="urgentQueue">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="card">
      <h3>âœ… è–ç‘ªå¯ç”¨åºŠä½</h3>
      <div id="availableBeds">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="card">
      <h3>ğŸ“Š å…¨é™¢åºŠä½ä½¿ç”¨ç‡</h3>
      <div id="occupancyChart">åˆ†æä¸­...</div>
    </div>

    <div class="card">
      <h3>ğŸ¯ æ™ºæ…§æœ€ä½³é…å°å»ºè­°</h3>
      <div id="smartRecommendation">ç­‰å¾…å»ºè­°...</div>
    </div>
  </div>

  <script type="text/javascript">
    // è–ç‘ªå°ˆå±¬åºŠä½è³‡æ–™ï¼ˆæœªä¾†æ¥FHIR Locationï¼‰
    let mockBeds = {
      'è–ç‘ª101å…§': { status: 'available', department: 'å…§ç§‘', cleaner: false, feature: 'å¿ƒå°ç®¡å®¤æ—' },
      'è–ç‘ª102å…§': { status: 'available', department: 'å…§ç§‘', cleaner: false, feature: 'æ™®é€šç—…æˆ¿' },
      'è–ç‘ª103å…§': { status: 'cleaning', department: 'å…§ç§‘', eta: '15åˆ†é˜' },
      'è–ç‘ª201å¤–': { status: 'available', department: 'å¤–ç§‘', cleaner: false, feature: 'æ‰‹è¡“å®¤æ—' },
      'è–ç‘ª202å¤–': { status: 'occupied', department: 'å¤–ç§‘', patient: 'ç‹å°æ˜', los: 2 },
      'è–ç‘ª301å¿ƒ': { status: 'available', department: 'å¿ƒè‡Ÿå…§ç§‘', cleaner: false, feature: 'CCUå‚™ç”¨' },
      'è–ç‘ª401åŠ ': { status: 'available', department: 'åŠ è­·', cleaner: false, feature: 'å‘¼å¸å™¨è¨­å‚™' }
    };

    let mockPatients = [
      { id: 'è–ç‘ª001', name: 'æå¤§è¡›', urgency: 'é«˜', department: 'å…§ç§‘', 
        aclsLevel: 3, expectedLOS: 2, fromER: true, transfer: false, priority: null },
      { id: 'è–ç‘ª002', name: 'é™³ç¾ç²', urgency: 'ä¸­', department: 'å¤–ç§‘', 
        aclsLevel: 2, expectedLOS: 5, fromER: true, transfer: false, priority: null },
      { id: 'è–ç‘ª003', name: 'è–ç‘ªVIP', urgency: 'é«˜', department: 'å¿ƒè‡Ÿå…§ç§‘', 
        aclsLevel: 3, expectedLOS: 3, fromER: true, transfer: true, vip: true, priority: null }
    ];

    // ğŸ”¥ æ ¸å¿ƒæ™ºæ…§å„ªå…ˆæ¬Šæ¼”ç®—æ³•
    function calculatePriority(patient, availableBeds) {
      const weights = { urgency: 0.40, acuity: 0.25, deptMatch: 0.20, los: 0.10, transfer: 0.05, vip: 0.05 };
      
      const urgencyScore = patient.fromER ? 100 : (patient.transfer ? 70 : 30);
      const acuityScore = patient.aclsLevel === 3 ? 100 : patient.aclsLevel === 2 ? 70 : 30;
      
      let bestDeptMatch = 0, bestBedId = null;
      for (const [bedId, bed] of Object.entries(availableBeds)) {
        if (bed.status !== 'available') continue;
        let matchScore = bed.department === patient.department ? 100 : 
                        isAdjacentDept(bed.department, patient.department) ? 70 : 30;
        if (matchScore > bestDeptMatch) {
          bestDeptMatch = matchScore;
          bestBedId = bedId;
        }
      }
      
      const losScore = patient.expectedLOS < 3 ? 100 : patient.expectedLOS <= 7 ? 50 : 20;
      const transferScore = patient.transfer ? 100 : 0;
      const vipScore = patient.vip ? 100 : 0;
      
      const priorityScore = 
        weights.urgency * urgencyScore +
        weights.acuity * acuityScore +
        weights.deptMatch * bestDeptMatch +
        weights.los * losScore +
        weights.transfer * transferScore +
        weights.vip * vipScore;
      
      return {
        score: Math.round(priorityScore * 10) / 10,
        bestBed: bestBedId,
        breakdown: { urgencyScore, acuityScore, bestDeptMatch, losScore, transferScore, vipScore }
      };
    }

    function isAdjacentDept(bedDept, patientDept) {
      const adjacent = {
        'å…§ç§‘': ['å¿ƒè‡Ÿå…§ç§‘', 'åŠ è­·'], 'å¤–ç§‘': ['åŠ è­·'], 'å¿ƒè‡Ÿå…§ç§‘': ['å…§ç§‘', 'åŠ è­·'], 'åŠ è­·': ['å…§ç§‘', 'å¤–ç§‘', 'å¿ƒè‡Ÿå…§ç§‘']
      };
      return adjacent[patientDept]?.includes(bedDept) || false;
    }

    function smartBedAssignment(waitingPatients, availableBeds) {
      const prioritized = waitingPatients.map(p => ({ ...p, priority: calculatePriority(p, availableBeds) }))
        .sort((a, b) => b.priority.score - a.priority.score);
      const assignments = [];
      
      for (const patient of prioritized) {
        if (patient.priority.bestBed && availableBeds[patient.priority.bestBed]) {
          assignments.push({ patient: patient.name, bed: patient.priority.bestBed, score: patient.priority.score });
          delete availableBeds[patient.priority.bestBed];
        }
      }
      return assignments;
    }

    // UIæ¸²æŸ“å‡½å¼
    function renderUrgentQueue() {
      const waiting = mockPatients.filter(p => !p.location).map(p => ({
        ...p,
        priority: calculatePriority(p, getAvailableBeds())
      })).sort((a, b) => b.priority.score - a.priority.score);

      document.getElementById('urgentQueue').innerHTML = `
        <table>
          <tr><th>æ™ºæ…§åˆ†æ•¸</th><th>å§“å</th><th>ç§‘åˆ¥</th><th>ACLS</th><th>ä¾†æº</th><th>å‹•ä½œ</th></tr>
          ${waiting.map(p => `
            <tr class="${p.urgency === 'é«˜' ? 'urgency-high' : 'urgency-med'}">
              <td><span class="priority-score">${p.priority.score}</span>
                <div class="score-breakdown">
                  ç·Šæ€¥:${p.priority.breakdown.urgencyScore} ACLS:${p.priority.breakdown.acuityScore} 
                  ç§‘åˆ¥:${p.priority.breakdown.bestDeptMatch} ${p.vip ? 'VIP+20' : ''}
                </div>
              </td>
              <td>${p.name}${p.vip ? ' ğŸ‘‘' : ''}</td>
              <td>${p.department}</td>
              <td>${p.aclsLevel}</td>
              <td>${p.fromER ? 'æ€¥è¨º' : 'è½‰è¨º'}</td>
              <td>${p.priority.bestBed ? 
                `<button class="assign-btn" onclick="assignBed('${p.id}', '${p.priority.bestBed}')">
                  åˆ†é… ${p.priority.bestBed}
                </button>` : 'ç„¡åºŠä½'}
              </td>
            </tr>
          `).join('')}
        </table>
      `;
    }

    function getAvailableBeds() {
      return Object.fromEntries(Object.entries(mockBeds).filter(([_, b]) => b.status === 'available'));
    }

    function renderAvailableBeds() {
      const available = Object.entries(getAvailableBeds());
      document.getElementById('availableBeds').innerHTML = `
        <table>
          <tr><th>åºŠè™Ÿ</th><th>ç§‘åˆ¥</th><th>ç‰¹è‰²</th></tr>
          ${available.map(([id, bed]) => `
            <tr><td>${id}</td><td>${bed.department}</td><td class="available">${bed.feature}</td></tr>
          `).join('')}
        </table>
        <p><strong>ç©ºåºŠæ•¸ï¼š${available.length}å¼µ</strong></p>
      `;
    }

    function renderOccupancy() {
      const total = Object.keys(mockBeds).length;
      const available = Object.values(getAvailableBeds()).length;
      const occupied = total - available;
      const rate = Math.round((occupied / total) * 100);
      
      document.getElementById('occupancyChart').innerHTML = `
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${rate}%; background: ${rate > 85 ? '#ff6b6b' : rate > 70 ? '#ffd43b' : '#51cf66'};">
            ${rate}%
          </div>
        </div>
        <p>ä½¿ç”¨ç‡ï¼š${rate}% (${occupied}/${total}) | ç©ºåºŠï¼š${available}å¼µ</p>
      `;
    }

    function smartRecommendation() {
      const waiting = mockPatients.filter(p => !p.location);
      const availableBeds = getAvailableBeds();
      const assignments = smartBedAssignment(waiting, { ...availableBeds });
      
      document.getElementById('smartRecommendation').innerHTML = `
        <div style="padding: 20px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 12px;">
          <h4>ğŸ¯ æ™ºæ…§æœ€ä½³é…å° (${assignments.length}/${waiting.length})</h4>
          ${assignments.map(a => `
            <div style="display: flex; justify-content: space-between; padding: 12px; background: white; margin: 8px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <span>ğŸ‘¤ ${a.patient}</span>
              <span style="color: #28a745; font-weight: bold;">â†’ ğŸ›ï¸ ${a.bed} (åˆ†æ•¸:${a.score})</span>
            </div>
          `).join('') || '<p style="color: #28a745; font-weight: bold;">âœ… åºŠä½å……è¶³ï¼Œç„¡éœ€èª¿åº¦</p>'}
          <div style="margin-top: 16px; font-size: 13px; color: #666;">
            æ¼”ç®—æ³•æ¬Šé‡ï¼šç·Šæ€¥åº¦40% + ACLS25% + ç§‘åˆ¥20% + ä½é™¢å¤©10% + è½‰è¨º5% + VIP5%
          </div>
        </div>
      `;
    }

    // äº‹ä»¶è™•ç†
    window.assignBed = function(patientId, bedId) {
      const patient = mockPatients.find(p => p.id === patientId);
      if (patient && mockBeds[bedId]) {
        patient.location = bedId;
        mockBeds[bedId].status = 'assigned';
        mockBeds[bedId].patient = patient.name;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        refreshDashboard();
      }
    };

    window.autoAssignAll = function() {
      const waiting = mockPatients.filter(p => !p.location);
      const availableBeds = getAvailableBeds();
      const assignments = smartBedAssignment(waiting, { ...availableBeds });
      
      assignments.forEach(({ patient, bed }) => {
        const p = mockPatients.find(mp => mp.name === patient);
        if (p) {
          p.location = bed;
          mockBeds[bed].status = 'assigned';
          mockBeds[bed].patient = patient;
        }
      });
      
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      refreshDashboard();
    };

    window.addDemoPatient = function() {
      const newId = `è–ç‘ª${String(mockPatients.length + 1).padStart(3, '0')}`;
      mockPatients.push({
        id: newId, name: `æ¸¬è©¦ç—…æ‚£${mockPatients.length + 1}`, urgency: 'ä¸­', 
        department: ['å…§ç§‘', 'å¤–ç§‘', 'å¿ƒè‡Ÿå…§ç§‘'][Math.floor(Math.random() * 3)], 
        aclsLevel: [1,2,3][Math.floor(Math.random() * 3)], expectedLOS: 3 + Math.floor(Math.random() * 5),
        fromER: Math.random() > 0.5, transfer: false, vip: Math.random() > 0.8
      });
      refreshDashboard();
    };

    function refreshDashboard() {
      renderUrgentQueue();
      renderAvailableBeds();
      renderOccupancy();
      smartRecommendation();
    }

    // ğŸ”¥ FHIRæ•´åˆï¼ˆTHAS Sandboxï¼‰
    function initFHIR() {
      FHIR.oauth2.ready().then(client => {
        document.getElementById('fhirStatus').style.display = 'block';
        console.log('âœ… è–ç‘ªæ™ºæ…§æ’åºŠ - FHIRé€£ç·šæˆåŠŸ');
        
        // è®€çœŸå¯¦åºŠä½
        client.request('Location').then(locs => {
          console.log('FHIRåºŠä½è³‡æ–™ï¼š', locs);
          // parseFhirBeds(locs); // æœªä¾†å¯¦ä½œ
        });
        
        // è®€å€™åºŠç—…æ‚£
        client.request('Encounter?status=arrived').then(encs => {
          console.log('FHIRå€™åºŠç—…æ‚£ï¼š', encs);
          // parseFhirPatients(encs);
        });
      }).catch(err => {
        console.log('â„¹ï¸ Demoæ¨¡å¼é‹è¡Œ');
      });
    }

    // åˆå§‹åŒ–
    refreshDashboard();
    setInterval(refreshDashboard, 5000); // 5ç§’æ›´æ–°
    initFHIR();

    // ç§‘åˆ¥ç¯©é¸
    document.getElementById('departmentFilter').addEventListener('change', function() {
      console.log('ç¯©é¸ç§‘åˆ¥ï¼š', this.value);
    });
  </script>
</body>
</html>